
<!DOCTYPE HTML>
<html lang="ja" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Memory Layout · Tock</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-theme-api/theme-api.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="Memory_Isolation.html" />
    
    
    <link rel="prev" href="TockBinaryFormat.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="検索すると入力" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="Overview.html">
            
                <a href="Overview.html">
            
                    
                    Overview
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="Design.html">
            
                <a href="Design.html">
            
                    
                    Design
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="threat_model/">
            
                <a href="threat_model/">
            
                    
                    Threat Model
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="Lifetimes.html">
            
                <a href="Lifetimes.html">
            
                    
                    Lifetimes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="Mutable_References.html">
            
                <a href="Mutable_References.html">
            
                    
                    Mutable References
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="Soundness.html">
            
                <a href="Soundness.html">
            
                    
                    Soundness
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="Compilation.html">
            
                <a href="Compilation.html">
            
                    
                    Compilation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.5" data-path="TockBinaryFormat.html">
            
                <a href="TockBinaryFormat.html">
            
                    
                    Tock Binary Format
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="2.6" data-path="Memory_Layout.html">
            
                <a href="Memory_Layout.html">
            
                    
                    Memory Layout
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.7" data-path="Memory_Isolation.html">
            
                <a href="Memory_Isolation.html">
            
                    
                    Memory Isolation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.8" data-path="Registers.html">
            
                <a href="Registers.html">
            
                    
                    Registers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.9" data-path="Startup.html">
            
                <a href="Startup.html">
            
                    
                    Startup
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.10" data-path="Syscalls.html">
            
                <a href="Syscalls.html">
            
                    
                    Syscalls
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.11" data-path="Userland.html">
            
                <a href="Userland.html">
            
                    
                    Userland
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.12" data-path="Networking_Stack.html">
            
                <a href="Networking_Stack.html">
            
                    
                    Networking Stack
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.13" data-path="Configuration.html">
            
                <a href="Configuration.html">
            
                    
                    Configuration
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="syscalls/">
            
                <a href="syscalls/">
            
                    
                    Syscall Interfaces
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="reference/">
            
                <a href="reference/">
            
                    
                    Internal Kernel Interfaces
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="Getting_Started.html">
            
                <a href="Getting_Started.html">
            
                    
                    Getting Started
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="Porting.html">
            
                <a href="Porting.html">
            
                    
                    Porting Tock
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3" data-path="OutOfTree.html">
            
                <a href="OutOfTree.html">
            
                    
                    Out of Tree Boards
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.4" data-path="debugging/README.md">
            
                <span>
            
                    
                    Debugging Help
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.5" >
            
                <span>
            
                    
                    [Style](Style.mdManagement of Tock
            
                </span>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="wg/">
            
                <a href="wg/">
            
                    
                    Working Groups
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2" data-path="CodeReview.html">
            
                <a href="CodeReview.html">
            
                    
                    Code Review Process
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            GitBookで公開 
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >Memory Layout</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="memory-layout">Memory Layout</h1>
<p>This document describes how the memory in Tock is structured and used for the
kernel, applications, and supporting state.</p>
<!-- npm i -g markdown-toc; markdown-toc -i Memory_Layout.md -->
<!-- toc -->
<ul>
<li><a href="#flash">Flash</a><ul>
<li><a href="#kernel-code">Kernel code</a></li>
<li><a href="#process-code">Process code</a></li>
</ul>
</li>
<li><a href="#ram">RAM</a><ul>
<li><a href="#kernel-ram">Kernel RAM</a></li>
<li><a href="#process-ram">Process RAM</a></li>
</ul>
</li>
<li><a href="#hardware-implementations">Hardware Implementations</a><ul>
<li><a href="#sam4l">SAM4L</a><ul>
<li><a href="#flash-1">Flash</a></li>
<li><a href="#ram-1">RAM</a></li>
<li><a href="#overview">Overview</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- tocstop -->
<p>Tock is intended to run on microcontrollers like the Cortex-M, which have
non-volatile flash memory (for code) and RAM (for stack and data) in a single
address space. While the Cortex-M architecture specifies a high-level layout of
the address space, the exact layout of Tock can differ from board to board.
Most boards simply define the beginning and end of flash and SRAM in their
<code>layout.ld</code> file and then include the <a href="../boards/kernel_layout.ld">generic Tock memory
map</a>.</p>
<h2 id="flash">Flash</h2>
<p>The nonvolatile flash memory holds the kernel code and a linked-list of sorts
of <a href="TockBinaryFormat.html">process code</a>.</p>
<h3 id="kernel-code">Kernel code</h3>
<p>The kernel code is split into two major regions. The first is <code>.text</code>, which
holds the vector table, program code, initialization routines, and other
read-only data.  This section is written to the beginning of flash.</p>
<p>The second major region following up the <code>.text</code> region is the <code>.relocate</code>
region.  It holds values that need to exist in SRAM, but have non-zero initial
values that Tock copies from flash to SRAM as part of its initialization (see
<a href="Startup.html">Startup</a>).</p>
<h3 id="process-code">Process code</h3>
<p>Processes are placed in flash starting at a known address which can be
retrieved in the kernel using the symbol <code>_sapps</code>. Each process starts with a
Tock Binary Format (TBF) header and then the actual application binary.
Processes are placed continuously in flash, and each process&apos;s TBF header
includes the entire size of the process in flash. This creates a linked-list
structure that the kernel uses to traverse apps. The end of the valid processes
are denoted by an invalid TBF header. Typically the flash page after the last
valid process is set to all 0x00 or 0xFF.</p>
<h2 id="ram">RAM</h2>
<p>The RAM holds the data currently being used by both the kernel and processes.</p>
<h3 id="kernel-ram">Kernel RAM</h3>
<p>The kernel RAM contains three major regions:</p>
<ol>
<li>Kernel stack.</li>
<li>Kernel data: initialized memory, copied from flash at boot.</li>
<li>Kernel BSS: uninitialized memory, zeroed at boot.</li>
</ol>
<h3 id="process-ram">Process RAM</h3>
<p>The process RAM is memory space divided between all running apps.</p>
<p>A process&apos;s RAM contains four major regions:</p>
<ol>
<li>Process stack</li>
<li>Process data</li>
<li>Process heap</li>
<li>Grant</li>
</ol>
<p>The figure below shows the memory space of one process.</p>
<p><img src="processram.png" alt="Process&apos; RAM"></p>
<h2 id="hardware-implementations">Hardware Implementations</h2>
<h3 id="sam4l">SAM4L</h3>
<p>The SAM4L is a microcontroller used on the Hail and Imix platforms, among
others. The structure of its flash and RAM is as follows.</p>
<h4 id="flash">Flash</h4>
<table>
<thead>
<tr>
<th>Address Range</th>
<th>Length (bytes)</th>
<th>Content</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x0-3FF</td>
<td>1024</td>
<td>Bootloader</td>
<td>Reserved flash for the bootloader.  Likely the vector table.</td>
</tr>
<tr>
<td>0x400-0x5FF</td>
<td>512</td>
<td>Flags</td>
<td>Reserved space for flags. If the bootloader is present, the first 14 bytes are &quot;TOCKBOOTLOADER&quot;.</td>
</tr>
<tr>
<td>0x600-0x9FF</td>
<td>1024</td>
<td>Attributes</td>
<td>Up to 16 key-value pairs of attributes that describe the board and the software running on it.</td>
</tr>
<tr>
<td>0xA00-0xFFFF</td>
<td>61.5k</td>
<td>Bootloader</td>
<td>The software bootloader provides non-JTAG methods of programming the kernel and applications.</td>
</tr>
<tr>
<td>0x10000-0x2FFFF</td>
<td>128k</td>
<td>Kernel</td>
<td>Flash space for the kernel.</td>
</tr>
<tr>
<td>0x30000-0x7FFFF</td>
<td>320k</td>
<td>Apps</td>
<td>Flash space for applications.</td>
</tr>
</tbody>
</table>
<h4 id="ram">RAM</h4>
<table>
<thead>
<tr>
<th>Address Range</th>
<th>Length (bytes)</th>
<th>Content</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x20000000-0x2000FFFF</td>
<td>64k</td>
<td>Kernel and app RAM</td>
<td>The kernel links with all of the RAM, and then allocates a buffer internally for application use.</td>
</tr>
</tbody>
</table>
<h4 id="overview">Overview</h4>
<p>The following image gives an example of how things are currently laid out in practice. It shows the address space of both flash and RAM with three running applications: crc, ip_sense, and analog_comparator.</p>
<p><img src="process_memory_layout.png" alt="Process memory layout"></p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            

        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Memory Layout","level":"2.6","depth":1,"next":{"title":"Memory Isolation","level":"2.7","depth":1,"path":"Memory_Isolation.md","ref":"Memory_Isolation.md","articles":[]},"previous":{"title":"Tock Binary Format","level":"2.5","depth":1,"path":"TockBinaryFormat.md","ref":"TockBinaryFormat.md","articles":[]},"dir":"ltr"},"config":{"plugins":["theme-api","livereload"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"livereload":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-api":{"languages":[],"split":true,"theme":"light"},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"Tock","language":"ja","gitbook":"*","description":"Tockドキュメント"},"file":{"path":"Memory_Layout.md","mtime":"2020-09-14T07:33:27.027Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2020-09-27T01:49:05.493Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-livereload/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-theme-api/theme-api.js"></script>
        
    

    </body>
</html>

